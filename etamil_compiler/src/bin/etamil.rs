#!/usr/bin/env rust-script
//! eTamil Direct Executor
//! Run .qmz files independently without compilation
//!
//! Usage:
//!   etamil <file.qmz>
//!   etamil -c <file.qmz>  (compile & execute)
//!   etamil -b <file.qmz>  (show bytecode)

use std::fs;
use std::process;

fn main() {
    let args: Vec<String> = std::env::args().collect();
    
    if args.len() < 2 {
        eprintln!("Usage: {} <file.qmz> [options]", args[0]);
        eprintln!("Options:");
        eprintln!("  -c, --compile    Compile to LLVM (legacy)");
        eprintln!("  -b, --bytecode   Show generated bytecode");
        eprintln!("  -h, --help       Show this help");
        process::exit(1);
    }
    
    let filename = &args[1];
    let mode = if args.len() > 2 {
        args[2].as_str()
    } else {
        "--vm"  // Default: run via VM
    };
    
    // Load the eTamil source code
    let source = match fs::read_to_string(filename) {
        Ok(content) => content,
        Err(e) => {
            eprintln!("Error reading file '{}': {}", filename, e);
            process::exit(1);
        }
    };
    
    println!("=== eTamil Direct Executor ===");
    println!("File: {}", filename);
    println!("Mode: {}\n", mode);
    
    match mode {
        "-c" | "--compile" => compile_and_run(&source),
        "-b" | "--bytecode" => show_bytecode(&source),
        "-h" | "--help" => print_help(&args[0]),
        _ => execute_via_vm(&source),
    }
}

fn print_help(prog: &str) {
    println!("eTamil Direct Executor v1.0");
    println!("\nUsage: {} [options] <file.qmz>", prog);
    println!("\nOptions:");
    println!("  -c, --compile    Compile to LLVM bytecode (default runtime)");
    println!("  -b, --bytecode   Show generated bytecode instructions");
    println!("  -h, --help       Show this help message");
    println!("\nExamples:");
    println!("  {} hello.qmz                    # Run via VM", prog);
    println!("  {} hello.qmz -c                  # Compile to LLVM", prog);
    println!("  {} hello.qmz -b                  # Show bytecode", prog);
}

fn execute_via_vm(source: &str) {
    // Would use: etamil_compiler::vm functions
    println!("Executing via eTamil VM...\n");
    println!("[VM Runtime Not Fully Integrated Yet]");
    println!("Source length: {} bytes", source.len());
    println!("\nRun with '-c' flag to use LLVM compilation method");
}

fn compile_and_run(_source: &str) {
    // Uses existing Rust compilation pipeline
    println!("Compiling via LLVM...\n");
    println!("[LLVM Compilation Pending]");
}

fn show_bytecode(source: &str) {
    // Show bytecode representation
    println!("Generated Bytecode:\n");
    println!("[Bytecode Not Generated Yet]");
    println!("Source: {} bytes", source.len());
}
