#!/bin/bash
# eTamil Direct Executor Script
# Execute .qmz files without compilation

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CARGO_ROOT="$SCRIPT_DIR/etamil_compiler"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Display usage
usage() {
    cat << EOF
eTamil Direct Executor v1.0

Usage: $0 [OPTIONS] <file.qmz>

Options:
  -h, --help          Show this help message
  -c, --compile       Use LLVM compilation (legacy)
  -b, --bytecode      Show generated bytecode
  -v, --verbose       Show detailed output
  -r, --release       Use optimized build

Examples:
  $0 program.qmz              # Run via VM (fast)
  $0 -c program.qmz           # Compile via LLVM
  $0 -b program.qmz           # Show bytecode

EOF
}

# Parse arguments
FILE=""
MODE="vm"
VERBOSE=0
BUILD_MODE="debug"

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -c|--compile)
            MODE="llvm"
            shift
            ;;
        -b|--bytecode)
            MODE="bytecode"
            shift
            ;;
        -v|--verbose)
            VERBOSE=1
            shift
            ;;
        -r|--release)
            BUILD_MODE="release"
            shift
            ;;
        *)
            FILE="$1"
            shift
            ;;
    esac
done

# Validate file
if [[ -z "$FILE" ]]; then
    echo -e "${RED}✗ Error: No file specified${NC}"
    usage
    exit 1
fi

# Convert to absolute path
if [[ ! "$FILE" = /* ]]; then
    FILE="$PWD/$FILE"
fi

if [[ ! -f "$FILE" ]]; then
    echo -e "${RED}✗ Error: File not found: $FILE${NC}"
    exit 1
fi

if [[ ! "$FILE" =~ \.qmz$ ]]; then
    echo -e "${YELLOW}⚠ Warning: File does not have .qmz extension${NC}"
fi

# Build command
BUILD_FLAGS="--quiet"
if [[ "$BUILD_MODE" == "release" ]]; then
    BUILD_FLAGS="$BUILD_FLAGS --release"
fi

RUN_FLAGS=""
if [[ "$MODE" == "llvm" ]]; then
    RUN_FLAGS="-- $FILE --llvm"
elif [[ "$MODE" == "bytecode" ]]; then
    RUN_FLAGS="-- $FILE --show-bytecode"
else
    RUN_FLAGS="-- $FILE"
fi

if [[ $VERBOSE -eq 1 ]]; then
    echo -e "${YELLOW}Building eTamil compiler...${NC}"
fi

# Build
cd "$CARGO_ROOT"
cargo build $BUILD_FLAGS --bin etamil_compiler 2>/dev/null || {
    echo -e "${RED}✗ Build failed${NC}"
    exit 1
}

if [[ $VERBOSE -eq 1 ]]; then
    echo -e "${GREEN}✓ Build complete${NC}"
    echo -e "${YELLOW}Executing: $FILE (mode: $MODE)${NC}"
    echo ""
fi

# Execute
BINARY="target/${BUILD_MODE}/etamil_compiler"
exec "$BINARY" $RUN_FLAGS
